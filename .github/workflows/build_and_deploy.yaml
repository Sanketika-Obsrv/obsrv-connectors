name: Obsrv Connectors build and deploy workflow
run-name: Workflow run for ${{ github.ref }}
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      aws-deploy:
        type: boolean
        required: true
        default: false
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  check-tag:
    runs-on: ubuntu-latest
    outputs:
      ALLOWED_TAG: ${{ steps.tag-checker.outputs.TRIGGER_ALLOWED }}
    steps:
      - name: Check if tag is one in list of current releases
        id: tag-checker
        run: |
          (echo -n TRIGGER_ALLOWED= && echo 'print("${{ github.ref_name }}".split("_")[0]
          not in "${{ vars.CURRENT_RELEASE }}")' | python3) >> "$GITHUB_OUTPUT"

  run-test-cases:
    runs-on: ubuntu-latest
    needs: check-tag
    if: needs.check-tag.outputs.ALLOWED_TAG ==  'True' && github.event_name == 'pull_request'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Download artifacts
          path: https://github.com/Sanketika-Obsrv/obsrv-core/actions/runs/7796585848/artifacts/*

      - name: Build obsrv core repository
        run: |
          # cd obsrv-connectors/obsrv-core
          mvn clean install -DskipTests

      - name: Run test case when raised a PR
        run: |
          cd ./jdbc-connector
          mvn clean install